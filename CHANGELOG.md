# Changelog - Just Speak It (EngCRM)

История изменений проекта.

## Февраль 2026

### 136. Улучшения Live Session — кнопки, аудио, скролл, ответы (24 февраля 2026)
- **Переименованы кнопки**: «Открыть» → «Предпросмотр» (просмотр урока), «Следовать за мной» → «Открыть» (запуск live-сессии)
- **Исправлено циклическое воспроизведение аудио/видео**: добавлен флаг `isRemoteAction` в `AudioRenderer` и `VideoRenderer` — предотвращает бесконечный цикл обратной связи при медиа-синхронизации
- **Кнопка «За мной»**: в баннере live-сессии преподаватель может прокрутить экран ученика к своей текущей позиции
  - Новый тип WebSocket-сообщения `scroll_to` с процентом скролла
  - Кнопка активна только при подключённом ученике
- **Правильные ответы для преподавателя**: исправлено отображение правильных ответов в live-режиме
  - В `TestRenderer` и `ImageChoiceRenderer`: добавлена проверка `canSeeAnswers` внутри ветки `serverDetails`
  - Невыбранные правильные варианты теперь подсвечиваются зелёным для преподавателя
- Изменено 4 файла: `LessonDetailModal.tsx`, `BlockRenderer.tsx`, `useLiveSession.ts`, `LessonPreviewPage.tsx`
- Коммит: `733595a`

### 135. Live Session — совместная работа учителя и ученика (24 февраля 2026)
- Новая фича: учитель и ученик работают вместе над курсовым материалом в реальном времени (как в Figma)
- **Модель «зеркало»**: ученик — источник правды, учитель видит read-only копию экрана ученика
- **Запуск**: кнопка «Следовать за мной» в модалке урока (таб «Курсы»), только для 1:1 уроков с прикреплёнными lesson-материалами
- **Баннер**: у студента появляется фиксированный баннер-приглашение с кнопкой «Присоединиться» (polling каждые 5 сек)
- **Синхронизация**: ответы, проверка, сброс, смена страницы — всё передаётся в реальном времени через WebSocket
- **Курсор-указка**: движение мыши учителя отображается у ученика как фиолетовый SVG-курсор с именем
- **Медиа-синхронизация**: play/pause/seek для `<video>` и `<audio>` синхронизируются между участниками
- **Reconnect**: auto-reconnect с exponential backoff (1s→10s, до 10 попыток), state snapshot при переподключении
- **Хранение сессий**: in-memory dict (без миграции БД), cleanup через 60 сек после отключения обоих
- **Backend**: REST (`POST /api/live-sessions/`, `GET /active`, `DELETE /{id}`) + WebSocket (`/ws/{id}`)
- **Frontend**: hook `useLiveSession`, компоненты `RemoteCursor`, `LiveSessionBanner`, API клиент `liveSessionApi`
- Создано 6 файлов, изменено 5 файлов (11 всего)
- Коммит: `a9f1944`

### 134. Исправление синхронизации учеников при переносе между группами (23 февраля 2026)
- При удалении ученика из группы `sync_group_students_to_future_lessons()` не удаляла его из будущих уроков старой группы
- **Причина**: `datetime.now()` в Docker-контейнере возвращала UTC, а уроки хранятся в локальном казахстанском времени (UTC+5) — из-за несоответствия часть уроков не попадала в выборку «будущих»
- **Исправление**: убрана проверка `Lesson.scheduled_at > datetime.now()`, синк теперь опирается только на `Lesson.status == LessonStatus.SCHEDULED`
- Безопасность: удаление из `lesson_students` только при `attendance_status == PENDING` (уже отмеченные не затрагиваются)
- Также вручную почищены orphaned записи для 2 учеников (Gilmutdinov — группа 41, Serikkazhy — группа 35)
- Изменено 1 файл: `groups.py`
- Коммит: `1969f68`

### 133. Уведомление учителю о низком балансе учеников при создании урока (23 февраля 2026)
- При создании урока (одиночного или batch) проверяется баланс каждого ученика
- Если `student.balance < lesson_type.price` — учитель получает уведомление типа `low_balance` в NotificationBell
- Сообщение содержит список учеников с текущим балансом и цену урока
- Работает в 4 эндпоинтах: `POST /api/lessons`, `POST /api/lessons/batch`, `POST /api/teacher/lessons`, `POST /api/teacher/lessons/batch`
- В batch-режиме — одно уведомление на всю пачку (не на каждый урок)
- Урок создаётся всегда — уведомление информативное, не блокирующее
- Изменено 2 файла: `lessons.py`, `teacher_dashboard.py`
- Коммит: `c802d80`

### 132. Очистка email от невидимых символов (23 февраля 2026)
- При копировании email из Telegram/WhatsApp в поле попадают невидимые Unicode-символы (zero-width space, non-breaking space и др.)
- Браузер показывает ошибку: `Часть адреса до символа "@" не должна содержать символ "".`
- Добавлена автоматическая очистка email от невидимых символов (`\u200B-\u200D`, `\u00AD`, `\uFEFF`, `\u00A0`, `\u2060`, `\u180E`) при вводе/вставке
- Исправлено в 3 местах: CreateUserModal, EditUserModal, LoginPage
- Коммит: `26507a9`

### 131. Исправление VideoRenderer — поддержка всех форматов YouTube (23 февраля 2026)
- Ранее поддерживались только `youtube.com/watch?v=XXX` и `youtu.be/XXX`
- Добавлена поддержка 5 новых форматов: YouTube Shorts (`/shorts/`), live (`/live/`), embed (`/embed/`), параметр `si` при шаринге, `v` не первым query-параметром
- Добавлена поддержка прямых видеофайлов (.mp4, .webm, .ogg) через `<video>` тег
- Fallback: любой URL с `/embed/` открывается как iframe (универсальная поддержка embed-виджетов)
- Коммиты: `26507a9`, `620331b`

### 130. Новый блок drag_words — перетаскивание слов (23 февраля 2026)
- Новый интерактивный блок `drag_words` (20-й тип) — перетаскивание слов на места в тексте
- **Формат данных**: текст с плейсхолдерами `{0}`, `{1}` + массив правильных слов + дистракторы (слова-ловушки)
- **Редактор**: textarea для текста с плейсхолдерами, кнопка «Добавить пропуск», поле для дистракторов через запятую
- **Рендерер**: пул перемешанных слов сверху, click-based взаимодействие (клик по слову → клик по пропуску), мобильная поддержка
- **Серверная проверка**: `_grade_drag_words()` в grading.py, подсветка зелёный/красный по каждому пропуску
- **Защита ответов**: `strip_answers_from_content()` убирает правильные слова, оставляет только индексы
- **Формат ответа**: `Record<number, string>` — аналог fill_gaps
- Миграция 030: `ALTER TYPE exerciseblocktype ADD VALUE 'drag_words'`
- Изменено 9 файлов: модель, схемы, grading, courses API, миграция, типы, BlockEditor, BlockRenderer, LessonEditorPage
- Коммит: `26507a9`

### 129. Карусель изображений в блоке image (23 февраля 2026)
- Блок `image` теперь поддерживает несколько изображений с навигацией каруселью
- **Структура данных**: новое поле `images: CarouselImage[]` (url + caption), обратная совместимость со старым `url`
- **Редактор**: кнопка «Карусель (несколько)» переключает в режим множественных изображений, каждое с загрузкой/URL + подпись + превью + перемещение вверх/вниз
- **Рендерер**: стрелки влево/вправо, точки-индикаторы, счётчик «N / M»; при 1 изображении — как раньше
- Миграция не нужна — данные хранятся в JSONB поле `content`
- Backend схема: добавлен `CarouselImage(BaseModel)` и поле `images` в `ImageBlockContent`
- Коммит: `26507a9`

### 128. Папки материалов — динамические вместо хардкода (19 февраля 2026)
- Новая модель `MaterialFolder` (id, title, position, created_at) — таблица `material_folders`
- Поле `folder_id` (nullable FK) добавлено в модель `Material`
- **Backend API** папок: `GET/POST /materials/folders`, `PUT/DELETE /materials/folders/{id}`
- Фильтрация материалов по папке: `GET /materials?folder_id=X`
- При удалении папки материалы сохраняются (folder_id → NULL)
- **Frontend**: динамические папки из API вместо 4 захардкоженных
- Inline создание/переименование/удаление папок (только admin)
- Кнопки действий с материалами видны только admin
- Заголовок страницы: «Методические материалы» → «Материалы»
- Вкладка «Уроки» → «Материалы» на дашборде студента
- Миграция 029 (часть 2): создание таблицы `material_folders`, добавление `folder_id`
- Изменено 6 файлов: модель, схемы, API, типы, api.ts, MaterialsPage, StudentDashboardPage
- Коммит: `92c5b52`

### 127. Авто-пагинация уроков по заголовкам (19 февраля 2026)
- Если в уроке нет блоков `page_break` и >= 3 блоков с title — автоматическая разбивка на страницы
- Каждый блок с title начинает новую страницу (блоки до первого title идут на первую страницу)
- Sidebar «Содержание» показывает все заголовки по всем страницам
- Клик по пункту содержания переключает на нужную страницу
- Подсветка активного пункта по текущей странице (вместо IntersectionObserver)
- Полная обратная совместимость: с page_break работает как раньше, без page_break и <3 title — один лист
- Коммит: `92c5b52`

### 126. Активные чаты менеджера (19 февраля 2026)
- Добавлены табы «Активные чаты» / «Все ученики» в ManagerMessagesPage
- «Активные чаты» — компонент `ConversationList` (GET `/api/direct-messages/conversations`)
- «Все ученики» — текущий список всех студентов с поиском
- Подсветка выбранного собеседника в списке активных чатов (selectedUserId проп)
- Backend изменения не потребовались
- Коммит: `92c5b52`

### 125. Сохранение контента при смене типа блока — расширенные группы (19 февраля 2026)
- Расширена логика сохранения контента при смене типа блока — 3 группы совместимости:
  - HTML-группа (text, teaching_guide, remember, article) → сохраняет `html`
  - Медиа-группа (video, audio) → сохраняет `url`, `title`
  - Тесты-группа (test, true_false, image_choice) → сохраняет `explanation`
- Confirm-диалог показывается только при переключении на несовместимый тип
- Ранее сохранялось только `html` между text/teaching_guide/remember/article
- Коммит: `92c5b52`

### 124. Sticky содержание урока (19 февраля 2026)
- Исправлен sticky sidebar «Содержание» в LessonPreviewPage
- Проблема: `<nav>` во flex-контейнере растягивался до высоты контента, sticky не работал
- Решение: добавлен `self-start` к `<nav>` — sidebar теперь следует при скролле
- Коммит: `92c5b52`

### 123. Убраны кнопки массового прикрепления материалов (19 февраля 2026)
- Удалены кнопки «Весь курс», «Вся секция», «Топик» из AttachCourseMaterialModal
- Удалён confirmation-диалог при прикреплении курса/секции
- Оставлены только кнопки «Добавить» для отдельных уроков
- Коммит: `92c5b52`

### 122. Email в любом регистре (19 февраля 2026)
- Нормализация email (`.strip().lower()`) при логине (`auth.py`), создании и обновлении пользователя (`users.py`)
- Миграция 029 (часть 1): `UPDATE users SET email = LOWER(TRIM(email))` — нормализация существующих email
- Пользователи теперь могут входить с email в любом регистре (Admin@School.com → admin@school.com)
- Коммит: `92c5b52`

### 121. Разбивка уроков курсов на страницы — блок page_break (18 февраля 2026)
- Новый тип блока `page_break` (19-й) в конструкторе курсов — разделяет урок на страницы
- **В редакторе**: отображается как оранжевая пунктирная линия с необязательной меткой (например, "Listening", "Grammar")
- **В превью урока**: блоки автоматически разделяются на страницы по позициям page_break
- Навигация: кнопки «Назад» / «Вперёд», кликабельные номера страниц, индикатор «Страница X из Y»
- Нумерация блоков сквозная (глобальная по всему уроку)
- Ответы студентов сохраняются при переключении между страницами
- Sidebar «Содержание» показывает блоки текущей страницы
- Полная обратная совместимость: уроки без page_break работают как раньше
- Миграция 028: добавление `page_break` в enum `exerciseblocktype`
- Изменено 7 файлов: модель, миграция, типы, BlockEditor, BlockRenderer, LessonEditorPage, LessonPreviewPage
- Коммит: `6192a99`

### 120. Удаление уроков с транзакциями (18 февраля 2026)
- Исправлена ошибка «Не удалось удалить урок» для уроков с отмеченной посещаемостью
- Причина: FK constraint `transaction.lesson_id → lessons.id` блокировал удаление
- Решение: перед удалением урока отвязываются все транзакции (`lesson_id = NULL`)
- Сами транзакции сохраняются для отчётности и истории
- Коммит: `8b7379c`

### 119. Полноценная посещаемость менеджера + серверная защита ответов (18 февраля 2026)
- **Fix 1: Посещаемость менеджера** — endpoint `POST /api/lessons/{id}/attendance`
  - Ранее endpoint менеджера только менял статус посещаемости, не списывал баланс и не начислял зарплату
  - Теперь полная логика: списание баланса ученика, начисление зарплаты преподавателю через матрицу цен, создание транзакций, уведомление о низком балансе, автоматический статус COMPLETED
  - Логика рефанда при переключении статусов (present → absent_excused и обратно)
- **Fix 2: Серверная защита ответов от учеников** — многоуровневая защита
  - Backend `strip_answers_from_content()` в `courses.py`: удаляет правильные ответы из JSON при отдаче контента студентам
  - Backend `grade_answer_detailed()` в `grading.py`: серверная проверка с возвратом результатов по каждому элементу (gap_results, option_results, pair_results)
  - Frontend: студенты используют `serverDetails` от сервера вместо локальной проверки
  - Блоки `teaching_guide` полностью скрыты от студентов на уровне API
  - Затронуты все 6 интерактивных рендереров: FillGaps, Test, TrueFalse, WordOrder, Matching, ImageChoice
- Коммит: `a877f84`

### 118. Отображение legacy-курсов в модалке прикрепления материалов (18 февраля 2026)
- Family and Friends и Market Leader используют legacy-структуру (уроки напрямую в секциях, без topics)
- Модалка прикрепления показывала «0 ур.» для всех уровней этих курсов
- Frontend теперь корректно обрабатывает оба формата дерева: topic→lesson и legacy section→lesson
- Исправлены: счётчик уроков, рендеринг списка, поиск с авто-раскрытием, подсказка следующего урока
- Коммит: `03f116c`

### 117. Синхронизация учеников группы с уроками (18 февраля 2026)
- При добавлении ученика в группу он автоматически появляется во всех будущих запланированных уроках группы
- При удалении ученика из группы он удаляется из будущих уроков (только если посещаемость ещё не отмечена — status `pending`)
- Завершённые, отменённые и прошедшие уроки не затрагиваются
- Одноразовый скрипт `sync_group_students.py` для синхронизации существующих данных (232 записи добавлены)
- Коммит: `1dc3d6c`, `f28e83d`

### 116. Вкладка «Домашнее задание» на дашборде студента (17 февраля 2026)
- Новая вкладка «Домашнее задание» между «Тесты» и «Сообщения» на дашборде студента
- Показывает **все** прикреплённые курсовые материалы за всё время (без ограничения в 30 дней)
- Новый endpoint `GET /api/student/homework` — аналог `/student/course-materials`, но без фильтра по дате
- Каждый материал — ссылка на `/student/course-material/{id}` или `/courses/lessons/{id}` для отдельных уроков
- Фиолетовая цветовая схема (отличается от cyan вкладки «Уроки» с PDF-файлами)
- Коммит: `5b49981`

### 115. Скрыты правильные ответы от учеников (16 февраля 2026)
- Студенты больше не видят правильные ответы после проверки упражнений
- **fill_gaps**: правильный ответ `({answer})` скрыт при ошибке (только для учителей)
- **test / image_choice**: невыбранные правильные варианты не подсвечиваются зелёным
- **true_false**: правильная кнопка не раскрывается если студент выбрал неправильную
- **word_order**: "Неправильно. Попробуйте ещё раз." вместо показа правильного предложения
- **matching**: "Есть ошибки. Попробуйте ещё раз." вместо показа правильных пар
- Учителя/админы/менеджеры по-прежнему видят все ответы (canSeeAnswers)
- Коммит: `e83bd0e`

### 114. Кнопка "Сбросить" для интерактивных упражнений (16 февраля 2026)
- Добавлена кнопка "Сбросить" для всех интерактивных блоков после проверки ответа
- Позволяет студентам очистить ответ и попробовать заново
- Коммит: `7964d51`

### 113. Улучшен выбор урока при прикреплении материала курса (16 февраля 2026)
- Auto-expand дерева при поиске — совпадающие ветки раскрываются автоматически
- Подсветка совпадений жёлтым цветом
- Кнопки "Весь курс" / "Вся секция" сделаны вторичными (серые), "Добавить" урок — зелёная
- Confirmation dialog при прикреплении целого курса/секции
- Счётчик уроков на секциях и топиках
- Коммит: `00ace86`

### 112. Поле ответа для fill_gaps без gaps + навигация по уроку (16 февраля 2026)
- **fill_gaps без gaps**: 154 блока с пустым массивом gaps теперь показывают textarea для свободного ответа
- **Навигация по уроку**: sidebar "Содержание" с IntersectionObserver для отслеживания активного блока
  - Desktop: sticky sidebar справа. Mobile: выдвижная панель
  - Показывается если >= 3 блока с заголовками
- Коммит: `8f1d81e`

### 111. Имена учеников в расписании для индивидуальных уроков (16 февраля 2026)
- Для уроков без группы в расписании отображаются имена учеников вместо "N уч."
- Добавлено поле `student_names` в схему `ScheduleLesson`
- SchedulePage: имена в ячейках и модалке дня
- TeacherDashboardPage: первые имена учеников
- Коммит: `c279b4c`

### 110. Оптимизация CI/CD сборки (16 февраля 2026)
- Убраны `gcc` и `libpq-dev` из Dockerfile (не нужны с asyncpg)
- Убран `--pull` флаг из `docker compose build` и `docker system prune -f` (убивали кэш)
- Увеличен SSH таймаут до 30 минут
- Коммит: `bd3096e`

### 109. Исправлен лимит пагинации при загрузке учеников (16 февраля 2026)
- Backend: `size` параметр в `GET /api/users` увеличен с `le=100` до `le=10000`
- Frontend: загрузка всех студентов в LessonCreateModal, ManagerMessagesPage, AddStudentsModal
- Исправлена проблема: менеджер не мог найти ученика при создании урока (671 студентов, лимит 100)

### 108. Исправлено отображение расписания после batch-создания и timezone баг (16 февраля 2026)
- **Fix 1: Расписание не обновлялось после batch-создания уроков**
  - В SchedulePage и TeacherDashboardPage модалка `LessonCreateModal` не получала `onBatchSubmit` callback
  - При создании уроков через "Расписание на несколько недель" уроки создавались в БД, но UI не обновлялся
  - Добавлен `onBatchSubmit` в обе страницы: SchedulePage вызывает `fetchLessons()`, TeacherDashboardPage — `refreshSchedule()` + обновление dashboard
- **Fix 2: Уроки в субботу вечером и воскресенье не показывались (timezone)**
  - `weekDates[6].toISOString()` конвертировал воскресенье 00:00 местного времени в субботу ~18-19:00 UTC
  - Backend сравнивал UTC-границы запроса с naive local time в БД — уроки после 18-19:00 субботы и все воскресные выпадали из выборки
  - Заменено `toISOString()` на локальное форматирование даты (`YYYY-MM-DDT00:00:00` / `YYYY-MM-DDT23:59:59`) в трёх страницах: SchedulePage, TeacherDashboardPage, StudentDashboardPage
- Коммит: `47aeca3`

### 107. Материалы курсов доступны ученику без отметки посещаемости (11 февраля 2026)
- Убрана проверка `attendance_status == PRESENT` для доступа к материалам курсов
- Ученик теперь видит PDF и курсовые материалы в модалке урока и во вкладке «Материалы» независимо от отметки преподавателя
- Изменены 3 endpoint-а:
  - `GET /api/lessons/{id}/course-materials` — убран фильтр PRESENT для студентов
  - `GET /api/student/course-materials` — убран фильтр PRESENT, достаточно быть назначенным на урок
  - `GET /api/student/course-material/{id}/view` — убрана проверка PRESENT (403), достаточно быть назначенным на урок
- Коммит: `26bf3bd`

### 106. Фильтрованный доступ студентов к курсовым материалам (11 февраля 2026)
- Студенты теперь видят **только прикреплённую часть** курса, а не весь курс
- Новый backend endpoint `GET /api/student/course-material/{id}/view` (StudentOnlyUser):
  - Проверяет PRESENT статус ученика в связанном уроке (403 если нет)
  - Возвращает отфильтрованное дерево: только прикреплённую секцию/топик/курс
  - Поддержка legacy-уроков (без topic, напрямую в секции)
  - Фильтрация неопубликованных уроков и пустых секций/топиков
- Новая страница `StudentCourseMaterialPage.tsx` — оглавление с секциями, топиками и уроками
  - Клик на урок → переход на LessonPreviewPage с упражнениями
  - Breadcrumb-навигация (Курс > Секция > Топик)
  - Кнопка "Назад"
- Для material_type=lesson — автоматический redirect на страницу урока
- Исправлены ссылки в StudentDashboardPage: course/section/topic → `/student/course-material/{id}`
- Новые Pydantic-схемы: StudentLessonItem, StudentTopicItem, StudentSectionItem, StudentCourseMaterialView
- Роут: `/student/course-material/:materialId`
- Коммит: `3bb64a7`

### 105. Материалы к уроку в модалке расписания ученика (10 февраля 2026)
- При клике на урок в расписании ученик видит прикреплённые материалы (PDF и курсовые)
- PDF материалы — красная иконка, прямая ссылка на открытие
- Курсовые материалы — голубая иконка, ссылка на урок/курс (курс/секция/топик/урок)
- Материалы подгружаются через `GET /api/lessons/{id}/materials` и `GET /api/lessons/{id}/course-materials`
- Для студентов курсовые материалы отображаются только если преподаватель отметил "Был"
- Коммит: `f354cab`

### 104. Исправлены права доступа преподавателя и кликабельность уроков ученика (10 февраля 2026)
- **Fix 1: Преподаватель не мог сохранить ссылку на урок** — `LessonDetailModal.tsx`
  - LessonDetailModal использовал `PUT /api/lessons/{id}` (ManagerUser) вместо `PUT /api/teacher/lessons/{id}` (TeacherUser)
  - Теперь при role=teacher вызывается `teacherApi.updateLesson()` с проверкой владения уроком
- **Fix 2: Преподаватель не мог отметить посещаемость** — `LessonDetailModal.tsx`
  - LessonDetailModal использовал `POST /api/lessons/{id}/attendance` (ManagerUser, без списания баланса)
  - Теперь при role=teacher вызывается `teacherApi.markAttendance()` (TeacherUser, с полной логикой баланса)
- **Fix 3: Преподаватель не мог отменить урок** — `LessonDetailModal.tsx`
  - Теперь при role=teacher вызывается `teacherApi.cancelLesson()` с уведомлением учеников
  - Кнопка "Удалить" скрыта для преподавателей (могут только отменять)
- **Fix 4: Уроки ученика в расписании не кликабельные** — `StudentDashboardPage.tsx`
  - Добавлены `onClick` обработчики на карточки уроков (mobile и desktop)
  - При клике открывается модалка с деталями: дата/время, преподаватель, тип, группа
  - Кнопка "Подключиться к уроку" если есть meeting_url
- Удалён debug-лог из `backend/app/api/lessons.py`
- Коммиты: `77a80e7`, `f354cab`

### 103. Сохранение контента при смене типа HTML-блока (10 февраля 2026)
- При смене типа между text, teaching_guide, remember и article HTML-содержимое сохраняется
- Диалог "Содержимое блока будет сброшено" появляется только при переключении на несовместимый тип
- Позволяет массово менять teaching_guide → text (сделать заметки учителя видимыми студентам) без потери контента
- Коммит: `e496056`

### 102. Подсказка правильных ответов для преподавателей (10 февраля 2026)
- При наведении курсора на интерактивные элементы преподаватели/менеджеры/админы видят правильный ответ (HTML `title`)
- **fill_gaps** — при наведении на пропуск показывается правильное слово/фраза
- **test** — при наведении на правильный вариант показывается "✓ Правильный ответ"
- **true_false** — при наведении на правильную кнопку ("Верно"/"Неверно") показывается "✓ Правильный ответ"
- **matching** — при наведении на элемент левого столбца показывается правильная пара
- Студенты подсказок не видят
- Коммиты: `7a83ba6`, `28e5576`, `d7dc10f`

### 101. WYSIWYG-редактор TipTap для HTML-блоков (10 февраля 2026)
- Заменены textarea с сырым HTML на визуальный редактор TipTap в 4 типах блоков: text, teaching_guide, remember, article
- Toolbar: жирный, курсив, подчёркнутый, зачёркнутый, H1-H3, маркированный/нумерованный список, ссылки, undo/redo
- Enter создаёт новый абзац, Shift+Enter — `<br>`
- Новый компонент: `frontend/src/components/HtmlEditor.tsx`
- Пакеты: `@tiptap/react`, `@tiptap/starter-kit`, `@tiptap/pm`, `@tiptap/extension-underline`, `@tiptap/extension-link`
- Коммит: `4463fe9`

### 100. Раздел "Неправильные глаголы" (10 февраля 2026)
- Реализован полноценный справочник неправильных глаголов (~137 шт.) вместо заглушки
- Файл данных `frontend/src/data/irregularVerbs.ts` — v1, v2, v3, перевод, транскрипция
- Поиск по всем полям (английские формы + русский перевод) со счётчиком результатов
- Произношение всех трёх форм через Web Speech API (озвучка: "go ... went ... gone")
- Адаптивный дизайн: таблица на desktop, карточки на mobile
- Добавлен пункт меню и роут для преподавателей (`/teacher/irregular-verbs`)
- Коммит: `46c144d`

### 99. Исправления прав доступа и UI для преподавателей (9 февраля 2026)
- **Fix 1: Права доступа к просмотру уроков** — `lessons.py`
  - Изменена зависимость endpoint `GET /api/lessons/{id}` с `ManagerUser` на `TeacherUser`
  - Преподаватели теперь могут просматривать детали своих уроков без ошибки "Не удалось загрузить урок"
- **Fix 2: UI модалки создания урока** — `LessonCreateModal.tsx`
  - Убраны цены из выпадающего списка типов уроков
  - Показывается только название типа урока (например, "Indiv" вместо "Indiv (5000.00 тг)")
- **Fix 3: Редактирование ссылки на урок** — `LessonDetailModal.tsx`
  - Добавлено поле для редактирования meeting_url прямо в модалке урока
  - Отображается во вкладке "Посещаемость" с голубым фоном
  - Доступно только для teacher/admin/manager (студенты видят готовую ссылку)
  - Кнопка "Сохранить" активна только при изменении ссылки
- **Fix 4: Ссылки на курсы** — `LessonDetailModal.tsx`, `lessons.py`
  - Исправлена проблема: клик "Открыть" на секции курса перекидывал на расписание
  - Backend теперь возвращает `course_id` для секций и топиков через связи (`section.course_id`, `topic.section.course_id`)
  - Frontend открывает `/courses/{course_id}/edit` для всех типов материалов (курс, секция, топик)
- **Fix 5: Отображение курсовых материалов** — `teacher_dashboard.py`, `TeacherDashboardPage.tsx`
  - В разделе "Уроки с материалами" теперь отображаются прикреплённые курсы/секции/топики
  - Backend endpoint `/api/teacher/lessons-with-materials` возвращает поле `course_materials[]`
  - Курсовые материалы отображаются с голубым фоном и иконкой книги
  - Показывается тип материала (course/section/topic/lesson)
- **Fix 6: Загрузка course_id через связи** — `lessons.py`
  - Добавлена безопасная логика извлечения `course_id` из связей с `hasattr()` проверками
  - Применено для `get_lesson_course_materials` и `attach_course_material`
  - Добавлены логи для отладки
- Коммиты: `0f52f1b`, `2dcbb14`, `98dea39`, `c4fef7f`

### 98. Парсинг и импорт курса Business English Market Leader (3 уровня)
- **Парсинг всех 3 уровней** курса Business English Market Leader (Edvibe)
  - Pre-Intermediate: 9 уроков, 100 блоков
  - Intermediate: 14 уроков, 396 блоков
  - Upper-Intermediate: 16 уроков, 484 блока
  - **Итого**: 39 уроков, 980 блоков
- **Особенности парсинга**:
  - Курс имеет accordion/collapsible структуру секций (отличается от EF4 и FF)
  - Батч-парсинг по 4 секции за раз для стабильности (избежание stale elements)
  - Скрипт `parse_ml_by_sections.py` с параметрами `--level`, `--start`, `--end`
- **Статистика типов блоков** (топ-5):
  - text: 267 | remember: 201 | essay: 133 | image: 127 | audio: 102
- **Импорт на production**:
  - Курс ID=15 успешно импортирован на https://lms.jsi.kz
  - Скрипт `import_ml_to_production.py` с автоматическим обрезанием длинных title до 255 символов
  - Скрипт объединения всех уровней: `merge_all_ml_levels.py`
- Файлы: `parse_ml_by_sections.py`, `merge_ml_jsons.py`, `merge_all_ml_levels.py`, `import_ml_to_production.py`, `deploy_ml_to_production.sh`

### 97. Переимпорт курса Family and Friends (6 уровней)
- **Перепарсинг всех 6 уровней** курса Family and Friends с обновлённым парсером (Playwright)
  - Новый парсер извлекает HTML интерактивных блоков (fill_gaps, test, matching и др.)
  - Level 1: 21 урок, 618 блоков
  - Level 2: 18 уроков, 547 блоков (3 урока восстановлены из предыдущего парсинга)
  - Level 3: 28 уроков, 824 блока
  - Level 4: 28 уроков, 661 блок
  - Level 5: 36 уроков, 1108 блоков
  - Level 6: 34 урока, 508 блоков
  - **Итого**: 166 уроков, 4294 блока
- **Исправление интерактивных блоков** через `fix_ff_blocks.py`:
  - fill_gaps: 211 рабочих + 79 конвертированы в text (нет данных для парсинга)
  - matching: 60 блоков
  - true_false: 55 блоков
  - test: 97 → конвертированы в text (формат FF не позволяет извлечь варианты ответов)
  - essay: 24 блока
  - image_choice: 14 блоков
- **Обновлён курс ID=12** на production сервере через `update_ff_docker.py`
- Скрипты: `parse_family_friends.py`, `fix_ff_blocks.py`, `update_ff_docker.py`

### 96. 7 исправлений по обратной связи от клиента
- **Fix 1: Удаление блоков в курсах с топиками** — `courses.py`
  - Добавлена функция `get_course_for_lesson()` для корректного получения курса через `lesson.section.course` или `lesson.topic.section.course`
  - Исправлены 6 эндпоинтов: update_lesson, delete_lesson, create_block, update_block, delete_block, reorder_blocks
- **Fix 2: Прикрепление материала курса к уроку** — `lessons.py`
  - Исправлен `attach_course_material()`: добавлена загрузка связи `topic.section.course` для уроков с topic_id
- **Fix 3: Просмотр курсов преподавателем** — `CourseEditorPage.tsx`
  - Преподаватели могут просматривать структуру курсов в режиме read-only
  - Скрыты кнопки создания/редактирования/удаления для не-админов
- **Fix 4: Статусы уроков преподавателя на вкладке "Уроки"** — `TeacherDashboardPage.tsx`
  - Добавлены цветные badge статусов (completed/today/past/upcoming) на вкладке "Уроки"
  - Поле `duration_minutes` добавлено в API `lessons-with-materials`
- **Fix 5: Загрузка фото профиля в S3** — `users.py`
  - Фото профиля теперь загружается в S3 через `_upload_file_to_storage()` вместо локального сохранения
  - Удаление старого фото из S3 при замене
- **Fix 6: Ограничение ролей для менеджера** — `users.py`, `CreateUserModal.tsx`
  - Менеджер может создавать только учеников и преподавателей (не админов и менеджеров)
  - Frontend фильтрует выпадающий список ролей на основе роли текущего пользователя
- **Fix 7: Прикрепление материалов преподавателем из расписания** — `TeacherDashboardPage.tsx`
  - При клике на урок в расписании открывается `LessonDetailModal` вместо `AttendanceModal`
  - Преподаватель видит вкладки: посещаемость, PDF материалы, материалы курсов

### 95. Добавление уровня Topic в иерархию курсов и UX улучшения
- **Реструктуризация курсов (Миграции 023-024)**:
  - Добавлен новый уровень **Topic** между Section и Lesson
  - Новая иерархия: Course → Section (Level) → **Topic** → Interactive Lesson → Exercise Block
  - Модель `CourseTopic` с полями: section_id, title, description, position
  - Обратная совместимость: InteractiveLesson поддерживает topic_id и section_id (nullable)
  - CourseMaterialType enum расширен: добавлено значение 'topic'
  - LessonCourseMaterial поддерживает прикрепление топиков к урокам
- **API endpoints для топиков**:
  - `POST /api/courses/sections/{section_id}/topics` — создать топик
  - `PUT/DELETE /api/courses/topics/{id}` — операции с топиком
  - `POST /api/courses/sections/{id}/topics/reorder` — изменить порядок топиков
  - `POST /api/courses/topics/{id}/lessons` — создать урок в топике
  - `POST /api/courses/topics/{id}/lessons/reorder` — изменить порядок уроков в топике
  - `GET /api/courses/tree` — теперь включает топики в дерево курсов
- **Frontend изменения**:
  - `AttachCourseMaterialModal.tsx` — добавлен уровень Topic с раскрывающимся деревом
  - `types/index.ts` — CourseMaterialType и CourseTreeItem обновлены для поддержки 'topic'
  - `api.ts` — courseMaterialsApi обновлен для работы с topic_id
- **UX улучшения**:
  - **Проблема 4**: Динамические цвета статусов уроков в расписании преподавателя
    - 5 состояний: completed (зелёный), today (синий), past (оранжевый), upcoming (жёлтый), cancelled (красный)
    - Легенда статусов внизу таблицы расписания
    - Иконка предупреждения для прошедших уроков требующих отметки
  - **Проблема 5**: Состояния загрузки списка учеников
    - Спиннер загрузки при запросе данных
    - Обработка ошибок с сообщением и кнопкой "Повторить"
    - Консольное логирование для отладки
  - **Проблема 3**: Подсказка при выборе групп в LessonCreateModal
    - Жёлтый блок-подсказка для admin/manager: "Сначала выберите преподавателя"
    - Появляется когда преподаватель не выбран
  - **Проблема 6**: Исправлена загрузка преподавателей в GroupsPage
    - Добавлен state `teachersLoading`
    - Текст "Загрузка..." в dropdown
    - Фильтр по роли teacher в API запросе
  - **Проблема 2**: Логирование ошибок прикрепления материалов курсов
    - Детальное логирование в backend: тип материала, ID, ошибки
    - Детальное логирование в frontend: payload, server response, status code
    - Отображение ошибок сервера пользователю

### 94. Исправления парсера Edvibe и реструктуризация курса
- Исправлено различение `teaching_guide` и `remember` блоков (проверка текста `.note-name`)
- Скрипт `fix_teaching_guide.py` для исправления 72 блоков в БД
- Исправлена проблема дублирования контента между секциями (точное совпадение названий вместо `:has-text()`)
- Добавлена проверка hash контента для ожидания загрузки новой секции в SPA
- Новая иерархия: Course → Level (секция) → Lessons → Blocks (вместо отдельного урока на каждую секцию)
- Скрипт `update_course_docker.py` для обновления существующего курса в Docker
- **Реструктурирован курс:** English File 4th - Beginner (ID: 10) — 1 секция, 31 урок, 1316 блоков
- Новые CLI аргументы парсера: `--course-name`, `--level-name`

### 93. Парсер курсов Edvibe и импорт в JSI LMS
- Создан автоматизированный парсер курсов с платформы Edvibe (Playwright + async Python)
- Поддержка трёх режимов: все курсы, один курс, один урок
- Сохранение сессии браузера (session.json) для повторных запусков без авторизации
- Навигация по SPA через клики (прямые URL не работают в Edvibe)
- Конвертация в формат JSI LMS: Course → Section → InteractiveLesson → ExerciseBlock
- Поддерживаемые типы блоков: image, video, audio, text, teaching_guide, remember
- Скрипты массового импорта на production сервер (batch_import.py, add_missing_lessons.py)
- **Импортирован курс:** English File 4th - Beginner (ID: 10) — 38 уроков, 1280 блоков упражнений
- Файлы: `scripts/edvibe_parser/parser.py`, `parse_missing.py`, `import_to_jsi.py`

**Исправления после импорта:**
- Исправлен парсинг текстовых блоков (text, teaching_guide, remember): поле `html` вместо `text`
- Очистка HTML от Vue.js атрибутов (`data-v-*`) и Edvibe классов
- Исправлен парсинг аудио блоков: корректное извлечение URL из `<audio src="...">` элементов
- Скрипт `extract_audio_urls.py` для извлечения аудио URL из Edvibe
- Обновлены 210 аудио блоков с правильными URL (media.docstorio.com)
- Скрипт `extract_titles.py` для извлечения заголовков упражнений из Edvibe
- Обновлены 655 блоков с заголовками (например "Introduce yourself", "Listen and repeat")
- Скрипт `convert_fillgaps.py` для конвертации текстовых блоков в интерактивные fill_gaps
- Конвертированы 178 блоков из text в fill_gaps с правильными ответами
- Скрипт `fix_fillgaps_format.py` для исправления формата маркеров: `{gap}` → `{0}`, `{1}`, `{2}`
- Исправлен формат 178 блоков fill_gaps (добавлены индексы в gaps)
- Скрипт `convert_empty_tests_to_text.py` для конвертации test блоков без options в text
- Конвертированы 43 блока test → text (блоки с пустыми options из-за каруселей Edvibe)
- Исправлена нумерация блоков: teaching_guide, divider, remember исключены из подсчёта

### 92. Прикрепление курсов к урокам из кабинета преподавателя
- Кнопка "PDF" — прикрепить PDF материал из базы
- Кнопка "Курс" — прикрепить материал из курса (курс/секция/урок)
- AttachCourseMaterialModal переведён на русский язык
- Древовидный выбор с поиском по названию

### 91. Ограничение создания курсов только для админа
- CoursesPage: кнопка "Создать курс" только для admin
- CoursesPage: кнопки редактирования/удаления только для admin
- CourseEditorPage: редирект на /courses если не admin
- LessonEditorPage: редирект на /courses если не admin
- Бэкенд уже требовал AdminUser, теперь фронтенд соответствует

### 90. Поддержка переносов строк в блоке "Заполнить пропуски"
- В редакторе: нажатие Enter для переноса на новую строку
- В рендерере: обработка \n через `<br />` теги
- Увеличен размер textarea с 3 до 6 строк
- Добавлена подсказка о нажатии Enter

### 89. Кнопки перемещения уроков в редакторе курса
- Стрелки ↑↓ для изменения порядка уроков в секции
- Кнопки появляются при наведении на урок
- Автосохранение через API reorder

### 88. Блок "Словарь" (Vocabulary)
- Новый тип блока `vocabulary` в enum ExerciseBlockType (миграция 022)
- Поля: слово (англ.), перевод, транскрипция (опционально)
- Кнопка произношения через Web Speech API
- Редактор VocabularyEditor, рендерер VocabularyRenderer

### 87. Названия блоков упражнений (Block Titles)
- Новое поле `title` в модели ExerciseBlock (миграция 021)
- Отображение в формате "1.1 Название блока" над каждым блоком
- Поле "Название блока (необязательно)" в редакторе блоков

### 86. Деплой конструктора курсов на production
- Миграции 019 и 020 успешно применены
- Новые таблицы: courses, course_sections, interactive_lessons, exercise_blocks, lesson_course_materials
- S3 интеграция включена (S3_ENABLED=true)

### 85. Загрузка файлов для курсов в S3
- API endpoint: POST /api/uploads/courses (до 50 МБ)
- Поддержка: jpg, png, gif, webp (изображения), mp3, wav, ogg, m4a (аудио)
- Компонент FileUploadButton в BlockEditor
- Файлы хранятся в S3 бакете jsi/courses/

### 84. Прикрепление материалов курсов к урокам (миграция 020)
- Модель LessonCourseMaterial с enum CourseMaterialType
- GET /api/courses/tree — дерево опубликованных курсов
- POST/GET/DELETE /api/lessons/{id}/course-materials
- Компонент AttachCourseMaterialModal
- Флаг needs_attendance для индикатора "Ожидается отметка"

### 83. Конструктор курсов (Course Constructor)
- Иерархия: Курс → Секции → Уроки → Блоки упражнений
- 18 типов блоков (контентные и интерактивные)
- Backend: модели Course, CourseSection, InteractiveLesson, ExerciseBlock
- Frontend: CoursesPage, CourseEditorPage, LessonEditorPage, LessonPreviewPage
- Миграция 019_add_course_constructor

---

## Январь 2026

### 82. Настройка автоматических бэкапов на production
- Скрипт backup-to-s3.sh для работы через Docker
- Cron задача 00:00 UTC ежедневно
- Конфигурация backup-config.env
- Логирование в /var/log/postgres-backup.log

### 81. Ограничение доступа к чатам
- Преподаватели могут писать только назначенным ученикам
- Ученики — только назначенным преподавателям и менеджерам
- Проверка через TeacherStudent

### 80. Прямые назначения преподаватель-ученик
- Модель TeacherStudent (миграция 018)
- Автоматическое создание связи при создании урока/группы

### 79. Исправлена загрузка в ps.kz S3
- Реализована загрузка через httpx с AWS Signature V4

### 78. CI/CD на новый сервер
- GitHub Secrets: VPS_HOST=78.40.108.93, VPS_USER=debian
- SSH ключ RSA 4096, деплой через appleboy/ssh-action

### 77. Автоматические бэкапы на новом сервере
- backup-to-s3.sh для Docker, cron 00:00 UTC
- Бэкапы в s3://jsi-backups/postgres-backup/

### 76. Интеграция с S3 Object Storage
- Файлы в ps.kz S3 (бакет jsi), бэкапы в jsi-backups
- S3StorageService с boto3

### 75. Миграция на новый сервер ps.kz
- 158.160.141.83 → 78.40.108.93 (ps.kz VPS, Debian 12)
- Новый домен lms.jsi.kz

### 74. Активация email-рассылки на production
- Почта justspeakit1@gmail.com
- EMAIL_ENABLED=true в docker-compose.prod.yml

### 73. Email-уведомления о новых сообщениях
- HTML-письмо при получении личного сообщения
- Поддержка Gmail/Yandex/Mail.ru
- Документация EMAIL_SETUP.md

### 72. Исправлена ошибка 500 в my-groups-for-lessons
- Добавлены поля teacher_name и students_count

### 71. Фильтрация студентов преподавателя по активности
- Только активные студенты (is_active=True)

### 70. Ограничение учеников для преподавателя при создании урока
- Преподаватель видит только учеников с которыми были уроки
- API: GET /api/teacher/my-students-for-lessons, my-groups-for-lessons

### 69. Чаты менеджер-ученик
- Раздел "Сообщения" (/messages) для admin/manager
- ManagerMessagesPage с DirectChat

### 68. Отчёт по транзакциям учеников
- Вкладка "Транзакции" в разделе Отчёты
- GET /api/reports/transactions

### 67. Отслеживание автора транзакций
- Поле created_by_id в Transaction (миграция 017)

### 66. Система автоматических бэкапов БД
- Ежедневные бэкапы в ps.kz S3 (00:00 UTC)
- Хранение 7 дней, сжатие gzip

### 65. Серверная фильтрация по роли в API users
- Параметр `role` в GET /api/users

### 64. Массовый импорт преподавателей из Excel
- 89 преподавателей из Преподы.xlsx

### 63. Автоматическая очистка ссылок на прошедшие занятия
- APScheduler удаляет meeting_url ежедневно в 00:00 UTC

### 62. Исправлено отображение групп преподавателя
- Исправлено сравнение is_active в SQLAlchemy

### 61. Исправлена ошибка 422 при создании урока преподавателем
- Схема TeacherLessonCreate без teacher_id

### 60. Правильная работа с timezone
- Конвертация datetime в UTC, функция normalize_datetime_to_utc

### 59. Прикрепление PDF из базы в чаты
- SelectMaterialModal с fuzzy search

### 58. Удалена вкладка "Материалы" у ученика
- Остались: Моя страница, Уроки, Тесты, Сообщения

### 57. Фильтры по ученикам и группам
- Поиск по имени/email, фильтрация групп

### 56. Подсветка уроков на текущую дату
- Голубой градиент и синяя рамка

### 55. Защита от удаления используемых типов занятий

### 54. Фильтрация уроков по ученику/группе

### 53. Исправлены права доступа к пользователям и группам
- Преподаватели могут читать GET /api/users и /api/groups

### 52. Ребрендинг на "Just Speak It"

### 51. Исправлены права доступа к типам занятий
- GET /api/lesson-types для преподавателей

### 50. Удаление пользователей (soft delete)

### 49. Преподаватели могут создавать уроки

### 48. Исправлен Mixed Content Error
- proxy_redirect в nginx

### 47. Автоинициализация настроек

### 46. Раздел "Уроки" для преподавателя
- Вкладка с папками всех уроков

### 45. Раздел "Уроки" для ученика
- Материалы к урокам, доступны 30 дней

### 44. Исправлен баг со списком учеников

### 43. Загрузка PDF материалов (до 50 МБ)

### 42. Начальное значение настройки WhatsApp (миграция 016)

### 41. CI/CD с production config

### 40. Документация архитектуры
- ARCHITECTURE.md, WEBSOCKET.md, DEPLOYMENT.md, DNS-SSL-SETUP.md

### 39. WebSocket через WSS

### 38. Безопасная конфигурация портов

### 37. Production deployment с доменом

### 36. Система привязки PDF к урокам (миграция 015)
- LessonMaterial, AttachMaterialModal

### 35. Уникальные иконки в меню

### 34. Загрузка баннера для новости

### 33. Полноценная система новостей

### 32. Кнопка WhatsApp для студентов

### 31. Автоматический логаут при 401

### 30. Страница настроек для админа (/settings)

### 29. 4 папки в разделе Материалы

### 28. Кнопки "Чат" и "Уроки" у преподавателя

### 27. Новости — кнопка в sidebar для учеников

### 26. База знаний — кнопка в sidebar

### 25. Переименована вкладка "Личные материалы" → "Уроки"

### 24. Объединены вкладки "Ученики" и "Группы"

### 23. Система настроек с WhatsApp (миграция 013)

### 22. Мобильная версия для учеников

### 21. nginx client_max_body_size = 20MB

### 20. Фото профиля в sidebar

### 19. Загрузка файлов в чат (до 10 МБ)

### 18. Словарь и Неправильные глаголы в sidebar

### 17. Экспорт отчётов в Excel

### 16. Личные сообщения преподаватель↔ученик

### 15. Повторяющиеся уроки (batch creation)

### 14. SearchableSelect для преподавателя

### 13. Исправлены графики на Dashboard

### 12. Рабочие вкладки "Ученики", "Классы"

### 11. Реальная статистика преподавателя

### 10. Убрана ссылка Telemost при создании, добавлена в AttendanceModal

### 9. Отображение доступности в расписании (зелёный фон)

### 8. Создание уроков из расписания

### 7. Teacher Availability — полный стек

### 6. BalanceChangeModal с типами занятий

### 5. SearchableSelect с fuzzy search

### 4. Переименованы статусы в LessonDetailModal

### 3. Убран баланс ученика из вкладки "Ученики"

### 2. Переименованы кнопки посещаемости: "Был", "Отмена", "Неявка"

### 1. Убрана колонка "% преподавателю" из LevelsPage
