# План реализации EngCRM

## Обзор проекта

CRM-система для образовательного центра с управлением пользователями, занятиями, материалами и финансами.

---

## Роли пользователей

| Роль | Описание | Доступ |
|------|----------|--------|
| **Администратор** | Полный доступ к системе | Все модули |
| **Менеджер** | Управление пользователями и аккаунтами | Пользователи, создание аккаунтов, выдача доступа |
| **Преподаватель** | Проведение занятий | Личные данные, материалы, тесты, уроки, расписание |
| **Студент** | Обучение | Личный профиль, баланс, доступные материалы, тесты |

---

## Workflow приложения

### Аутентификация
```
[Форма входа] → [Проверка роли] → [Панель согласно роли]
```
- **Регистрация**: НЕ реализуется (аккаунты создаёт менеджер)
- **Восстановление пароля**: НЕ реализуется (доступ выдаёт менеджер)

### Администратор
```
[Панель администратора]
    ├── Пользователи (просмотр, поиск)
    ├── Типы занятий (CRUD: название, стоимость)
    ├── Уровни (CRUD: название, % преподавателю)
    ├── Материалы (CRUD: PDF файлы)
    ├── Тесты (CRUD)
    └── Отчёты (формирование по датам)
```

### Менеджер
```
[Панель менеджера]
    ├── Пользователи
    │   ├── Список (имя, телефон, почта, роль, уровень)
    │   ├── Добавить пользователя
    │   ├── Профиль пользователя
    │   └── Выдать/закрыть доступ
    └── Личные данные
```

### Преподаватель
```
[Панель преподавателя]
    ├── Личные данные (имя, телефон, почта, фото, уровень)
    ├── Материалы (доступные PDF)
    ├── Тесты (доступные тесты)
    └── Уроки
        ├── Список уроков
        ├── Добавить урок
        │   ├── Название занятия
        │   ├── Дата/время
        │   ├── Тип занятия
        │   └── Добавить студентов
        ├── Создать встречу (Яндекс.Телемост)
        ├── Занятие проведено (списание с баланса студента → начисление преподавателю)
        ├── Неявка (списание с баланса студента → начисление преподавателю)
        └── Отменить
```

### Студент
```
[Панель студента]
    ├── Личные данные (имя, телефон, почта, фото)
    ├── Баланс
    ├── Материалы (доступные по уровню)
    ├── Тесты (доступные по уровню)
    └── Расписание (ссылки на встречи)
```

---

## Бизнес-логика

### Уровни и оплата
- Каждый преподаватель имеет уровень (присваивает/меняет только администратор)
- Уровень определяет % оплаты преподавателю за занятие
- При групповых занятиях сумма умножается на количество студентов

### Проведение занятия
1. Преподаватель создаёт урок (название, дата, тип, студенты)
2. Нажимает "Создать встречу" → генерируется ссылка Яндекс.Телемост
3. Ссылка приходит студентам в личный кабинет
4. После занятия:
   - **"Занятие проведено"**: сумма списывается с баланса студента, начисляется преподавателю
   - **"Неявка"**: сумма также списывается/начисляется (штраф за неявку)
   - **"Отменить"**: без финансовых операций

### Доступ к материалам
- Менеджер выдаёт доступ к материалам/тестам конкретным студентам
- Список студентов с кнопками "Открыть доступ" / "Закрыть доступ"

---

## Структура базы данных

### Основные сущности

```
users
├── id (PK)
├── name
├── phone
├── email
├── password_hash
├── role (admin | manager | teacher | student)
├── level_id (FK, nullable)
├── photo_url
├── balance (для студентов)
├── created_at
└── updated_at

levels
├── id (PK)
├── name
├── teacher_percentage (% преподавателю)
├── created_at
└── updated_at

lesson_types
├── id (PK)
├── name
├── price
├── created_at
└── updated_at

lessons
├── id (PK)
├── title
├── teacher_id (FK → users)
├── lesson_type_id (FK → lesson_types)
├── scheduled_at (datetime)
├── meeting_url (Яндекс.Телемост)
├── status (scheduled | completed | cancelled | no_show)
├── created_at
└── updated_at

lesson_students
├── id (PK)
├── lesson_id (FK → lessons)
├── student_id (FK → users)
├── attended (boolean)
└── created_at

materials
├── id (PK)
├── title
├── file_url (PDF)
├── created_at
└── updated_at

material_access
├── id (PK)
├── material_id (FK → materials)
├── student_id (FK → users)
├── granted_by (FK → users, менеджер)
├── granted_at
└── revoked_at (nullable)

tests
├── id (PK)
├── title
├── created_at
└── updated_at

test_access
├── id (PK)
├── test_id (FK → tests)
├── student_id (FK → users)
├── granted_by (FK → users)
├── granted_at
└── revoked_at (nullable)

transactions
├── id (PK)
├── user_id (FK → users)
├── amount
├── type (debit | credit)
├── lesson_id (FK → lessons, nullable)
├── description
├── created_at
└── updated_at

reports
├── id (PK)
├── generated_by (FK → users)
├── date_from
├── date_to
├── file_url
├── created_at
└── updated_at
```

---

## Этапы реализации

### Этап 1: Базовая инфраструктура
- [ ] Инициализация проекта (выбор стека: Python/Django или Node.js)
- [ ] Настройка базы данных (PostgreSQL)
- [ ] Создание моделей данных
- [ ] Настройка аутентификации (JWT)
- [ ] Базовый API для CRUD операций

### Этап 2: Модуль пользователей
- [ ] Форма входа
- [ ] Панель менеджера: список пользователей
- [ ] Создание/редактирование пользователей
- [ ] Назначение ролей
- [ ] Назначение уровней (только админ для преподавателей)

### Этап 3: Справочники (Администратор)
- [ ] CRUD типов занятий
- [ ] CRUD уровней
- [ ] CRUD материалов (загрузка PDF)
- [ ] CRUD тестов

### Этап 4: Модуль занятий (Преподаватель)
- [ ] Список уроков преподавателя
- [ ] Создание урока (название, дата, тип, студенты)
- [ ] Интеграция с Яндекс.Телемост API
- [ ] Статусы занятия (проведено/неявка/отмена)
- [ ] Финансовые операции при изменении статуса

### Этап 5: Модуль студента
- [ ] Личный профиль
- [ ] Просмотр баланса и истории транзакций
- [ ] Список доступных материалов
- [ ] Список доступных тестов
- [ ] Расписание с ссылками на встречи

### Этап 6: Управление доступом (Менеджер)
- [ ] Выдача/закрытие доступа к материалам
- [ ] Выдача/закрытие доступа к тестам
- [ ] Изменение баланса студента

### Этап 7: Отчёты (Администратор)
- [ ] Формирование отчётов по датам
- [ ] Экспорт в PDF/Excel

### Этап 8: UI/UX
- [ ] Реализация дизайна согласно Figma
- [ ] Адаптивная вёрстка
- [ ] Поиск и фильтрация в списках

### Этап 9: Тестирование и деплой
- [ ] Unit-тесты
- [ ] Интеграционные тесты
- [ ] Настройка CI/CD
- [ ] Деплой на сервер

---

## Технологический стек (рекомендация)

### Backend
- **Python 3.11+** + **Django 5.x** / **FastAPI**
- **PostgreSQL** — основная БД
- **Redis** — кэширование, сессии
- **Celery** — фоновые задачи (отчёты, уведомления)

### Frontend
- **React** / **Vue.js** с TypeScript
- **Tailwind CSS** — стилизация
- Или **Django Templates** для MVP

### Интеграции
- **Яндекс.Телемост API** — создание встреч
- **S3-совместимое хранилище** — PDF материалы

### Инфраструктура
- **Docker** + **Docker Compose**
- **Nginx** — reverse proxy
- **GitHub Actions** — CI/CD

---

## Примечания из Figma

1. **Пример уровней**: В столбце "Сумма" указана оплата преподавателю за занятие. При групповых занятиях сумма умножается на количество человек.

2. **Пример занятий**: Сумма вычитается из баланса ученика. В окне занятий должна быть таблица с возможностью добавления/удаления/редактирования.

3. **Уровни преподавателей**: У каждого преподавателя есть свой уровень. Уровень может присваивать или менять только администратор.

4. **Яндекс.Телемост**: При нажатии "Создать встречу" преподаватель перекидывается в Яндекс.Телемост, создаётся встреча, ссылка приходит студентам в личный кабинет.

5. **Неявка**: При неявке стоимость занятия списывается у студента и начисляется преподавателю (сумма соответствует типу занятия).
