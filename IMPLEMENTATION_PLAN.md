# План реализации EngCRM

## Обзор проекта

CRM-система для образовательного центра с управлением пользователями, занятиями, материалами и финансами.

---

## Роли пользователей

| Роль | Описание | Доступ |
|------|----------|--------|
| **Администратор** | Полный доступ к системе | Все модули |
| **Менеджер** | Управление пользователями и аккаунтами | Пользователи, создание аккаунтов, выдача доступа |
| **Преподаватель** | Проведение занятий | Личные данные, материалы, тесты, уроки, расписание |
| **Студент** | Обучение | Личный профиль, баланс, доступные материалы, тесты |

---

## Workflow приложения

### Аутентификация
```
[Форма входа] → [Проверка роли] → [Панель согласно роли]
```
- **Регистрация**: НЕ реализуется (аккаунты создаёт менеджер)
- **Восстановление пароля**: НЕ реализуется (доступ выдаёт менеджер)

### Администратор
```
[Панель администратора]
    ├── Пользователи (просмотр, поиск)
    ├── Типы занятий (CRUD: название, стоимость)
    ├── Уровни (CRUD: название, % преподавателю)
    ├── Материалы (CRUD: PDF файлы)
    ├── Тесты (CRUD)
    └── Отчёты (формирование по датам)
```

### Менеджер
```
[Панель менеджера]
    ├── Пользователи
    │   ├── Список (имя, телефон, почта, роль, уровень)
    │   ├── Добавить пользователя
    │   ├── Профиль пользователя
    │   └── Выдать/закрыть доступ
    └── Личные данные
```

### Преподаватель
```
[Панель преподавателя]
    ├── Личные данные (имя, телефон, почта, фото, уровень)
    ├── Материалы (доступные PDF)
    ├── Тесты (доступные тесты)
    └── Уроки
        ├── Список уроков
        ├── Добавить урок
        │   ├── Название занятия
        │   ├── Дата/время
        │   ├── Тип занятия
        │   └── Добавить студентов
        ├── Создать встречу (Яндекс.Телемост)
        ├── Занятие проведено (списание с баланса студента → начисление преподавателю)
        ├── Неявка (списание с баланса студента → начисление преподавателю)
        └── Отменить
```

### Студент
```
[Панель студента]
    ├── Личные данные (имя, телефон, почта, фото)
    ├── Баланс
    ├── Материалы (доступные по уровню)
    ├── Тесты (доступные по уровню)
    └── Расписание (ссылки на встречи)
```

---

## Бизнес-логика

### Уровни и оплата
- Каждый преподаватель имеет уровень (присваивает/меняет только администратор)
- Уровень определяет % оплаты преподавателю за занятие
- При групповых занятиях сумма умножается на количество студентов

### Проведение занятия
1. Преподаватель создаёт урок (название, дата, тип, студенты)
2. Нажимает "Создать встречу" → генерируется ссылка Яндекс.Телемост
3. Ссылка приходит студентам в личный кабинет
4. После занятия:
   - **"Занятие проведено"**: сумма списывается с баланса студента, начисляется преподавателю
   - **"Неявка"**: сумма также списывается/начисляется (штраф за неявку)
   - **"Отменить"**: без финансовых операций

### Доступ к материалам
- Менеджер выдаёт доступ к материалам/тестам конкретным студентам
- Список студентов с кнопками "Открыть доступ" / "Закрыть доступ"

---

## Структура базы данных

### Основные сущности

```
users
├── id (PK)
├── name
├── phone
├── email
├── password_hash
├── role (admin | manager | teacher | student)
├── level_id (FK, nullable)
├── photo_url
├── balance (для студентов)
├── created_at
└── updated_at

levels
├── id (PK)
├── name
├── teacher_percentage (% преподавателю)
├── created_at
└── updated_at

lesson_types
├── id (PK)
├── name
├── price
├── created_at
└── updated_at

lessons
├── id (PK)
├── title
├── teacher_id (FK → users)
├── lesson_type_id (FK → lesson_types)
├── scheduled_at (datetime)
├── meeting_url (Яндекс.Телемост)
├── status (scheduled | completed | cancelled | no_show)
├── created_at
└── updated_at

lesson_students
├── id (PK)
├── lesson_id (FK → lessons)
├── student_id (FK → users)
├── attended (boolean)
└── created_at

materials
├── id (PK)
├── title
├── file_url (PDF)
├── created_at
└── updated_at

material_access
├── id (PK)
├── material_id (FK → materials)
├── student_id (FK → users)
├── granted_by (FK → users, менеджер)
├── granted_at
└── revoked_at (nullable)

tests
├── id (PK)
├── title
├── created_at
└── updated_at

test_access
├── id (PK)
├── test_id (FK → tests)
├── student_id (FK → users)
├── granted_by (FK → users)
├── granted_at
└── revoked_at (nullable)

transactions
├── id (PK)
├── user_id (FK → users)
├── amount
├── type (debit | credit)
├── lesson_id (FK → lessons, nullable)
├── description
├── created_at
└── updated_at

reports
├── id (PK)
├── generated_by (FK → users)
├── date_from
├── date_to
├── file_url
├── created_at
└── updated_at
```

---

## Этапы реализации

### Этап 1: Базовая инфраструктура ✅
- [x] Инициализация проекта (FastAPI + React + TypeScript)
- [x] Настройка базы данных (PostgreSQL + SQLAlchemy async)
- [x] Создание моделей данных
- [x] Настройка аутентификации (JWT)
- [x] Базовый API для CRUD операций
- [x] Docker Compose для разработки

### Этап 2: Модуль пользователей ✅
- [x] Форма входа
- [x] Панель менеджера: список пользователей с поиском
- [x] Создание пользователей (модальное окно)
- [x] Профиль пользователя (просмотр/редактирование)
- [x] Назначение ролей
- [ ] Назначение уровней преподавателям (привязка к справочнику уровней)

### Этап 3: Справочники (Администратор) ✅
- [x] CRUD типов занятий (LessonTypesPage)
- [x] CRUD уровней (LevelsPage)
- [x] CRUD материалов (MaterialsPage) — базовый, без загрузки файлов
- [x] CRUD тестов (TestsPage) — базовый

### Этап 3.1: Dashboard и расписание ✅
- [x] Dashboard со статистикой (карточки метрик)
- [x] Графики Recharts (уроки, доход)
- [x] Список ближайших уроков
- [x] Страница расписания (SchedulePage)
- [x] Недельный календарь с временной сеткой
- [x] Фильтр по учителям
- [x] Модальное окно деталей дня

### Этап 3.2: Отчёты (частично) ✅
- [x] Отчёт по оплате преподавателям (ReportsPage)
- [x] Фильтрация по датам
- [ ] Экспорт в PDF/Excel

### Этап 4: Модуль занятий (Преподаватель) ⏳
- [x] API для уроков (CRUD + schedule)
- [ ] Панель преподавателя (TeacherDashboard)
- [ ] Создание урока (название, дата, тип, студенты)
- [ ] Интеграция с Яндекс.Телемост API
- [ ] Изменение статуса занятия (проведено/неявка/отмена)
- [ ] Финансовые операции при изменении статуса

### Этап 5: Модуль студента ❌
- [ ] Панель студента (StudentDashboard)
- [ ] Личный профиль
- [ ] Просмотр баланса и истории транзакций
- [ ] Список доступных материалов
- [ ] Список доступных тестов
- [ ] Расписание с ссылками на встречи

### Этап 6: Управление доступом (Менеджер) ❌
- [ ] Выдача/закрытие доступа к материалам
- [ ] Выдача/закрытие доступа к тестам
- [ ] Изменение баланса студента (пополнение)

### Этап 7: Интеграции ❌
- [ ] Загрузка PDF файлов (S3/MinIO)
- [ ] Яндекс.Телемост API
- [ ] Экспорт отчётов PDF/Excel

### Этап 8: UI/UX ⏳
- [x] Реализация дизайна согласно Figma (админ-панель)
- [ ] Адаптивная вёрстка
- [x] Поиск и фильтрация в списках

### Этап 9: Тестирование и деплой ✅
- [x] Unit-тесты (базовый health check тест)
- [ ] Интеграционные тесты
- [x] Настройка CI/CD (полный pipeline)
- [x] Деплой на сервер

---

## Прогресс

| Этап | Статус | Прогресс |
|------|--------|----------|
| 1. Базовая инфраструктура | ✅ Готово | 100% |
| 2. Модуль пользователей | ✅ Готово | 90% |
| 3. Справочники админа | ✅ Готово | 100% |
| 3.1 Dashboard/Расписание | ✅ Готово | 100% |
| 3.2 Отчёты | ⏳ В работе | 70% |
| 4. Модуль преподавателя | ⏳ В работе | 20% |
| 5. Модуль студента | ❌ Не начат | 0% |
| 6. Управление доступом | ❌ Не начат | 0% |
| 7. Интеграции | ❌ Не начат | 0% |
| 8. UI/UX | ⏳ В работе | 60% |
| 9. Тестирование/деплой | ✅ Готово | 90% |

**Общий прогресс: ~60%**

---

## Технологический стек (используется)

### Backend
- **Python 3.11** + **FastAPI**
- **PostgreSQL 16** — основная БД
- **SQLAlchemy 2.x** (async) — ORM
- **Pydantic 2.x** — валидация данных
- **python-jose** — JWT токены
- **passlib + bcrypt** — хеширование паролей

### Frontend
- **React 18** + **TypeScript**
- **Vite 6** — сборка
- **Tailwind CSS 3** — стилизация
- **Zustand** — state management
- **Axios** — HTTP клиент
- **Recharts** — графики
- **React Router 7** — маршрутизация

### Интеграции (планируется)
- **Яндекс.Телемост API** — создание встреч
- **S3/MinIO** — PDF материалы

### Инфраструктура
- **Docker** + **Docker Compose**
- **Nginx** — reverse proxy (в продакшене)
- **GitHub Actions** — CI/CD (настроено базово)

---

## Примечания из Figma

1. **Пример уровней**: В столбце "Сумма" указана оплата преподавателю за занятие. При групповых занятиях сумма умножается на количество человек.

2. **Пример занятий**: Сумма вычитается из баланса ученика. В окне занятий должна быть таблица с возможностью добавления/удаления/редактирования.

3. **Уровни преподавателей**: У каждого преподавателя есть свой уровень. Уровень может присваивать или менять только администратор.

4. **Яндекс.Телемост**: При нажатии "Создать встречу" преподаватель перекидывается в Яндекс.Телемост, создаётся встреча, ссылка приходит студентам в личный кабинет.

5. **Неявка**: При неявке стоимость занятия списывается у студента и начисляется преподавателю (сумма соответствует типу занятия).

---

## Информация о деплое

### Production сервер
| Параметр | Значение |
|----------|----------|
| **IP адрес** | `158.160.141.83` |
| **SSH пользователь** | `admin` |
| **Frontend URL** | http://158.160.141.83:3005 |
| **Backend API** | http://158.160.141.83:8005 |
| **API Docs** | http://158.160.141.83:8005/api/docs |
| **Health Check** | http://158.160.141.83:8005/health |

### Порты (изменены с дефолтных)
| Сервис | Порт |
|--------|------|
| PostgreSQL | 5435 |
| Backend | 8005 |
| Frontend | 3005 |

### Учётные данные администратора
- **Email:** `admin@engcrm.com`
- **Пароль:** `admin123`

### GitHub репозиторий
- **URL:** https://github.com/Fe0fan0v/english-crm
- **Ветка:** `main`

### CI/CD Pipeline
Файл: `.github/workflows/ci-cd.yml`

При каждом пуше в `main`:
1. **Backend Tests** — pytest с PostgreSQL
2. **Frontend Checks** — ESLint + TypeScript build
3. **Docker Build Test** — сборка образов с кэшированием
4. **Deploy to Production** — автодеплой на VPS через SSH

GitHub Secrets (нужны для деплоя):
- `VPS_HOST` — IP сервера
- `VPS_USER` — SSH пользователь
- `VPS_SSH_KEY` — приватный SSH ключ

### Команды на сервере
```bash
# Подключение
ssh admin@158.160.141.83

# Директория проекта
cd ~/english-crm

# Просмотр логов
docker compose logs -f

# Перезапуск
docker compose down && docker compose up -d

# Инициализация БД (создание админа)
docker compose exec backend python -m app.utils.init_db
```

---

## Следующие шаги (приоритет)

### Высокий приоритет
1. **Модуль преподавателя (Этап 4)**
   - Панель преподавателя (TeacherDashboard)
   - Создание/редактирование уроков
   - Изменение статуса занятия
   - Финансовые операции при проведении урока

2. **Модуль студента (Этап 5)**
   - Панель студента (StudentDashboard)
   - Просмотр баланса и расписания
   - Доступ к материалам и тестам

### Средний приоритет
3. **Управление доступом (Этап 6)**
   - Выдача доступа к материалам/тестам
   - Пополнение баланса студента

4. **Экспорт отчётов (Этап 3.2)**
   - PDF/Excel генерация

### Низкий приоритет
5. **Интеграции (Этап 7)**
   - Яндекс.Телемост API
   - Загрузка PDF файлов

6. **UI/UX (Этап 8)**
   - Адаптивная вёрстка
   - Панели для других ролей

---

## История изменений

### 2026-01-11
- Перенос репозитория на GitHub (Fe0fan0v/english-crm)
- Настройка полного CI/CD pipeline с тестами и автодеплоем
- Деплой на VPS (158.160.141.83)
- Изменение портов: PostgreSQL 5435, Backend 8005, Frontend 3005
- Инициализация БД и создание администратора
- Добавлен ESLint конфиг для frontend
- Добавлены базовые тесты для backend
