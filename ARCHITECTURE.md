# ะััะธัะตะบัััะฐ EngCRM - ะะดัะตัะฐ ะธ ะผะฐัััััะธะทะฐัะธั

## ๐ ะัะฑะปะธัะฝัะต ะฐะดัะตัะฐ (ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปะตะน)

### Frontend
```
https://justspeak.heliad.ru
```
- ะะปะฐะฒะฝะฐั ัััะฐะฝะธัะฐ ะฟัะธะปะพะถะตะฝะธั
- ะัะพะด ะฒ ัะธััะตะผั
- ะัะต UI ะบะพะผะฟะพะฝะตะฝัั

### Backend API
```
https://justspeak.heliad.ru/api/*
```
- ะัะต API endpoints ะดะพัััะฟะฝั ัะตัะตะท ะฟัะตัะธะบั `/api`
- ะัะธะผะตัั:
  - `https://justspeak.heliad.ru/api/auth/login`
  - `https://justspeak.heliad.ru/api/users`
  - `https://justspeak.heliad.ru/api/lessons`

### Backend Health Check
```
https://justspeak.heliad.ru/health
```
- ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั backend

### API ะะพะบัะผะตะฝัะฐัะธั (Swagger)
```
https://justspeak.heliad.ru/api/docs
```
- ะะฝัะตัะฐะบัะธะฒะฝะฐั ะดะพะบัะผะตะฝัะฐัะธั API

### WebSocket (ะััะฟะฟะพะฒะพะน ัะฐั)
```
wss://justspeak.heliad.ru/api/groups/ws/{group_id}/chat?token={jwt_token}
```
- Real-time ะณััะฟะฟะพะฒะพะน ัะฐั
- ะะฒัะพะผะฐัะธัะตัะบะธะน ะฒัะฑะพั ะฟัะพัะพะบะพะปะฐ (WSS ะฝะฐ HTTPS, WS ะฝะฐ HTTP)
- ะกะผ. ะฟะพะดัะพะฑะฝะพััะธ ะฒ [WEBSOCKET.md](WEBSOCKET.md)

## ๐ ะะฝัััะตะฝะฝะธะต ะฐะดัะตัะฐ (ะดะพัััะฟะฝั ัะพะปัะบะพ ะฝะฐ ัะตัะฒะตัะต)

### Frontend Container
```
127.0.0.1:3005
```
- Nginx ะบะพะฝัะตะนะฝะตั
- ะะฐะทะดะฐัั ััะฐัะธัะตัะบะธะต ัะฐะนะปั (HTML, CSS, JS)
- **ะะ ะดะพัััะฟะตะฝ** ะธะทะฒะฝะต (ัะพะปัะบะพ localhost)

### Backend Container
```
127.0.0.1:8005
```
- FastAPI ะฟัะธะปะพะถะตะฝะธะต
- ะะฑัะฐะฑะฐััะฒะฐะตั API ะทะฐะฟัะพัั
- **ะะ ะดะพัััะฟะตะฝ** ะธะทะฒะฝะต (ัะพะปัะบะพ localhost)

### PostgreSQL Database
```
127.0.0.1:5435
```
- ะะฐะทะฐ ะดะฐะฝะฝัั
- **ะะ ะดะพัััะฟะฝะฐ** ะธะทะฒะฝะต (ัะพะปัะบะพ localhost)

## ๐ ะะฐะบ ัะฐะฑะพัะฐะตั ะผะฐัััััะธะทะฐัะธั

### 1. ะะพะปัะทะพะฒะฐัะตะปั ะพัะบััะฒะฐะตั ัะฐะนั

```
ะัะฐัะทะตั ะฟะพะปัะทะพะฒะฐัะตะปั
    โ HTTPS ะทะฐะฟัะพั
https://justspeak.heliad.ru
    โ
Nginx (ัะตัะฒะตั 158.160.141.83:443)
    โ ะฟัะพะบัะธััะตั ะฝะฐ
Frontend Container (127.0.0.1:3005)
    โ ะฒะพะทะฒัะฐัะฐะตั
index.html + JavaScript ัะฐะนะปั
```

### 2. Frontend ะดะตะปะฐะตั API ะทะฐะฟัะพั

**ะะพะด ะฒ ะฑัะฐัะทะตัะต (frontend/src/services/api.ts):**
```typescript
const api = axios.create({
  baseURL: "/api",  // ะัะฝะพัะธัะตะปัะฝัะน ะฟััั!
});

// ะะฐะฟัะพั:
await api.get("/users")
```

**ะะฐััััั ะทะฐะฟัะพัะฐ:**
```
JavaScript ะฒ ะฑัะฐัะทะตัะต
    โ HTTP ะทะฐะฟัะพั
https://justspeak.heliad.ru/api/users
    โ
Nginx (ะพะฟัะตะดะตะปัะตั ะผะฐััััั ะฟะพ ะฟัะตัะธะบัั /api)
    โ ะฟัะพะบัะธััะตั ะฝะฐ
Backend Container (127.0.0.1:8005)
    โ FastAPI ะพะฑัะฐะฑะฐััะฒะฐะตั
GET /api/users โ ะฒะพะทะฒัะฐัะฐะตั ะดะฐะฝะฝัะต
```

### 3. WebSocket ัะพะตะดะธะฝะตะฝะธะต (ะััะฟะฟะพะฒะพะน ัะฐั)

**ะะพะด ะฒ ะฑัะฐัะทะตัะต (frontend/src/services/api.ts):**
```typescript
getWebSocketUrl: (groupId: number): string => {
  const token = localStorage.getItem("token");
  const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
  const host = window.location.host;
  return `${protocol}//${host}/api/groups/ws/${groupId}/chat?token=${token}`;
}
```

**ะะฐััััั ัะพะตะดะธะฝะตะฝะธั:**
```
JavaScript ัะพะทะดะฐัั WebSocket
    โ WSS ะทะฐะฟัะพั (Upgrade: websocket)
wss://justspeak.heliad.ru/api/groups/ws/5/chat?token=...
    โ
Nginx (ะฒะธะดะธั Upgrade ะทะฐะณะพะปะพะฒะพะบ)
    โ ะฟัะพะบัะธััะตั WebSocket ะฝะฐ
Backend Container (127.0.0.1:8005)
    โ FastAPI WebSocket handler
Real-time ะดะฒัััะพัะพะฝะฝัั ัะฒัะทั
```

### 4. ะะฐะณััะทะบะฐ ััะฐัะธัะตัะบะธั ัะฐะนะปะพะฒ

```
ะัะฐัะทะตั ะทะฐะฟัะฐัะธะฒะฐะตั
    โ
https://justspeak.heliad.ru/assets/index-DSNp97S9.js
    โ
Nginx (ะฟัะตัะธะบั ะฝะต /api, ะฝะต /health)
    โ ะฟัะพะบัะธััะตั ะฝะฐ
Frontend Container (127.0.0.1:3005)
    โ ะฒะพะทะฒัะฐัะฐะตั
JavaScript ัะฐะนะป
```

## ๐ Nginx ะบะพะฝัะธะณััะฐัะธั

**ะคะฐะนะป:** `/etc/nginx/sites-available/justspeak.heliad.ru`

```nginx
server {
    server_name justspeak.heliad.ru;

    # Backend API (ะฒะบะปััะฐั WebSocket)
    location /api {
        proxy_pass http://127.0.0.1:8005;

        # WebSocket ะฟะพะดะดะตัะถะบะฐ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # ะกัะฐะฝะดะฐััะฝัะต headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # ะขะฐะนะผะฐััั ะดะปั ะดะพะปะณะธั ัะพะตะดะธะฝะตะฝะธะน
        proxy_read_timeout 300;
        proxy_connect_timeout 300;
    }

    # Backend Health
    location /health {
        proxy_pass http://127.0.0.1:8005/health;
    }

    # Frontend (ะฒัั ะพััะฐะปัะฝะพะต)
    location / {
        proxy_pass http://127.0.0.1:3005;
    }

    # SSL ัะตััะธัะธะบะฐั
    listen 443 ssl;
    ssl_certificate /etc/letsencrypt/live/justspeak.heliad.ru/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/justspeak.heliad.ru/privkey.pem;
}

# ะะตะดะธัะตะบั HTTP -> HTTPS
server {
    listen 80;
    server_name justspeak.heliad.ru;
    return 301 https://$host$request_uri;
}
```

## ๐ง Frontend ะบะพะฝัะธะณััะฐัะธั

### Axios baseURL (frontend/src/services/api.ts)
```typescript
const api = axios.create({
  baseURL: "/api",  // ะัะฝะพัะธัะตะปัะฝัะน ะฟััั!
});
```

**ะะพัะตะผั `/api` ะฐ ะฝะต ะฟะพะปะฝัะน URL?**

โ **ะัะฐะฒะธะปัะฝะพ** (ะพัะฝะพัะธัะตะปัะฝัะน ะฟััั):
```typescript
baseURL: "/api"
```
- ะะฐะฑะพัะฐะตั ะฝะฐ ะปัะฑะพะผ ะดะพะผะตะฝะต
- ะัะฐัะทะตั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟะพะดััะฐะฒะธั ัะตะบััะธะน ะดะพะผะตะฝ
- ะะฐะฟัะพั: `https://justspeak.heliad.ru/api/users`
- Nginx ะฟัะพะบัะธััะตั ะฝะฐ backend

โ **ะะตะฟัะฐะฒะธะปัะฝะพ** (ะฐะฑัะพะปััะฝัะน URL):
```typescript
baseURL: "http://158.160.141.83:8005"
```
- ะะต ะฑัะดะตั ัะฐะฑะพัะฐัั (ะฟะพัั ะทะฐะบััั)
- ะัะพะฑะปะตะผั ั CORS
- ะะต ะธัะฟะพะปัะทัะตั SSL

## ๐ก๏ธ CORS ะบะพะฝัะธะณััะฐัะธั

**Backend (docker-compose.prod.yml):**
```yaml
CORS_ORIGINS: '["https://justspeak.heliad.ru"]'
```

**ะงัะพ ััะพ ะทะฝะฐัะธั:**
- Backend ะฟัะธะฝะธะผะฐะตั ะทะฐะฟัะพัั **ัะพะปัะบะพ** ั ะดะพะผะตะฝะฐ `https://justspeak.heliad.ru`
- ะะฐะฟัะพัั ั ะดััะณะธั ะดะพะผะตะฝะพะฒ ะฑะปะพะบะธัััััั
- ะะฐัะธัะฐ ะพั ะฝะตัะฐะฝะบัะธะพะฝะธัะพะฒะฐะฝะฝะพะณะพ ะดะพัััะฟะฐ

## โ ะัะพะฒะตัะบะฐ ะฟัะฐะฒะธะปัะฝะพััะธ ะบะพะฝัะธะณััะฐัะธะธ

### 1. Frontend ะดะพัััะฟะตะฝ
```bash
curl -I https://justspeak.heliad.ru
# ะะถะธะดะฐะตััั: HTTP/1.1 200 OK
```

### 2. Backend API ะดะพัััะฟะตะฝ
```bash
curl https://justspeak.heliad.ru/health
# ะะถะธะดะฐะตััั: {"status":"healthy"}
```

### 3. ะะพััั ะทะฐะบัััั ัะฝะฐััะถะธ
```bash
curl http://158.160.141.83:3005
# ะะถะธะดะฐะตััั: timeout ะธะปะธ connection refused

curl http://158.160.141.83:8005
# ะะถะธะดะฐะตััั: timeout ะธะปะธ connection refused
```

### 4. HTTPS ัะตะดะธัะตะบั ัะฐะฑะพัะฐะตั
```bash
curl -I http://justspeak.heliad.ru
# ะะถะธะดะฐะตััั: HTTP/1.1 301 Moved Permanently
# Location: https://justspeak.heliad.ru/
```

## ๐ฏ ะัะพะณะพะฒะฐั ััะตะผะฐ

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ะะฝะตัะฝะธะน ะผะธั (Internet)                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                              โ
              https://justspeak.heliad.ru (443)
              http://justspeak.heliad.ru (80 โ 301 โ 443)
                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              Nginx (158.160.141.83:443)                      โ
โ  - SSL ัะตัะผะธะฝะฐัะธั                                            โ
โ  - ะะฐัััััะธะทะฐัะธั ะฟะพ ะฟัะตัะธะบัั                                 โ
โ  - ะัะพะบัะธัะพะฒะฐะฝะธะต ะฝะฐ localhost                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                    โ                    โ
        /api, /health              / (ะฒัั ะพััะฐะปัะฝะพะต)
                    โ                    โ
โโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Backend (FastAPI)   โ   โ  Frontend (Nginx/React)          โ
โ  127.0.0.1:8005      โ   โ  127.0.0.1:3005                  โ
โ  - API endpoints     โ   โ  - ะกัะฐัะธัะตัะบะธะต ัะฐะนะปั             โ
โ  - ะะฑัะฐะฑะพัะบะฐ ะดะฐะฝะฝัั  โ   โ  - HTML, CSS, JS                 โ
โโโโโโโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
          โ
โโโโโโโโโโโโโโโโโโโโโโโโ
โ  PostgreSQL          โ
โ  127.0.0.1:5435      โ
โ  - ะะฐะทะฐ ะดะฐะฝะฝัั       โ
โโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ ะะปััะตะฒัะต ะผะพะผะตะฝัั

1. **ะัั ะดะพัััะฟะฝะพ ัะพะปัะบะพ ัะตัะตะท ะพะดะธะฝ ะดะพะผะตะฝ**: `https://justspeak.heliad.ru`

2. **Frontend ะฝะต ะทะฝะฐะตั ัะพัะฝัะน ะฐะดัะตั backend**:
   - ะัะฟะพะปัะทัะตั ะพัะฝะพัะธัะตะปัะฝัะต ะฟััะธ (`/api`)
   - ะัะฐัะทะตั ัะฐะผ ะฟะพะดััะฐะฒะปัะตั ะดะพะผะตะฝ
   - Nginx ะฟัะพะบัะธััะตั ะฝะฐ ะฝัะถะฝัะน ัะตัะฒะธั

3. **ะะตะทะพะฟะฐัะฝะพััั**:
   - ะัะต ะฒะฝัััะตะฝะฝะธะต ัะตัะฒะธัั ะทะฐะบัััั (127.0.0.1)
   - ะะพัััะฟ ัะพะปัะบะพ ัะตัะตะท Nginx
   - SSL ะดะปั ะฒัะตั ัะพะตะดะธะฝะตะฝะธะน
   - CORS ะพะณัะฐะฝะธัะตะฝ ะพะดะฝะธะผ ะดะพะผะตะฝะพะผ

4. **ะัะพััะพัะฐ ัะฐะทัะฐะฑะพัะบะธ**:
   - ะะพะบะฐะปัะฝะพ: `docker-compose.yml` ะพัะบััะฒะฐะตั ะฟะพััั
   - Production: `docker-compose.prod.yml` ะทะฐะบััะฒะฐะตั ะฟะพััั
   - Frontend ะบะพะด ะฝะต ะผะตะฝัะตััั (ะธัะฟะพะปัะทัะตั `/api`)

5. **ะะฐัััะฐะฑะธััะตะผะพััั**:
   - ะะตะณะบะพ ะดะพะฑะฐะฒะธัั CDN
   - ะะตะณะบะพ ะดะพะฑะฐะฒะธัั load balancer
   - ะะตะณะบะพ ัะผะตะฝะธัั ะดะพะผะตะฝ (ะฝัะถะฝะพ ัะพะปัะบะพ ะพะฑะฝะพะฒะธัั nginx ะธ CORS)
