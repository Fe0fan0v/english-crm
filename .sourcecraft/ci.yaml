# EngCRM CI/CD Configuration for SourceCraft

on:
  pull_request:
    - workflows: [test, lint]
      filter:
        target_branches: [main, develop]
  push:
    - workflows: [test, lint]
      filter:
        branches: [main, develop]
    - workflows: [build, deploy]
      filter:
        branches: [main]

workflows:
  lint:
    tasks:
      - name: lint-code
        cubes:
          - name: python-lint
            image: python:3.11-slim
            script:
              - pip install ruff
              - ruff check .
          - name: frontend-lint
            image: node:20-alpine
            script:
              - cd frontend
              - npm ci
              - npm run lint

  test:
    tasks:
      - name: backend-tests
        cubes:
          - name: python-tests
            image: python:3.11-slim
            env:
              DATABASE_URL: postgresql://test:test@localhost:5432/test_db
              SECRET_KEY: test-secret-key
            script:
              - pip install -r requirements.txt
              - pytest --cov=app --cov-report=xml
      - name: frontend-tests
        cubes:
          - name: node-tests
            image: node:20-alpine
            script:
              - cd frontend
              - npm ci
              - npm run test

  build:
    tasks:
      - name: build-backend
        cubes:
          - name: docker-build-backend
            image: docker:24-dind
            script:
              - docker build -t engcrm-backend:$CI_COMMIT_SHA .
              - docker tag engcrm-backend:$CI_COMMIT_SHA engcrm-backend:latest
      - name: build-frontend
        cubes:
          - name: docker-build-frontend
            image: docker:24-dind
            script:
              - cd frontend
              - docker build -t engcrm-frontend:$CI_COMMIT_SHA .
              - docker tag engcrm-frontend:$CI_COMMIT_SHA engcrm-frontend:latest

  deploy:
    tasks:
      - name: deploy-staging
        cubes:
          - name: deploy
            image: alpine:3.19
            env:
              DEPLOY_ENV: staging
            script:
              - apk add --no-cache curl openssh-client
              - echo "Deploying to staging environment..."
              # Add deployment scripts here
      - name: deploy-production
        cubes:
          - name: deploy
            image: alpine:3.19
            env:
              DEPLOY_ENV: production
            script:
              - apk add --no-cache curl openssh-client
              - echo "Deploying to production environment..."
              # Add deployment scripts here
